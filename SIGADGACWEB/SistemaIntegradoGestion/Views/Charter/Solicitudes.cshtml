
@model IEnumerable<CapaModelo.tbSolicitudVuelo>
@{
    ViewBag.Title = "Solicitudes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<br />
<div class="card card-default">
    <div class="card-body">
        <div class="row">
            <div class="col-sm-12">
                <table class="text-center text-blue text-sm" style="width:100%">
                    <tr>
                        <td class="col-sm-2"></td>
                        <td class="col-sm-7"><h5><b>DIRECCIÓN GENERAL DE AVIACIÓN CIVIL DEL ECUADOR</b> </h5></td>
                        <td class="col-sm-3"></td>
                    </tr>
                    <tr>
                        <td class="col-sm-2"></td>
                        <td class="col-sm-7"><h6>DETALLE DE SOLICITUDES DE VUELOS CHARTER Y ESPECIALES</h6> </td>
                        <td class="col-sm-3"></td>
                    </tr>
                    <tr>
                        <td class="col-sm-2"></td>
                        <td class="col-sm-7">
                            <h6 id="tituloSolicitud">DETAIL OF CHARTER AND SPECIAL FLIGHT REQUESTS</h6>
                        </td>
                        <td>
                            <div class="col-md-12 font-14">
                                <div class="checkbox checkbox-primary pull-left p-t-0">
                                    <a href="@Url.Action("ManualUsuario", "Charter")" class="text-primary m-l-5"><b>Descargar manual usuario</b></a>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
    <div class="card-body">
        <div class="btn-group">
            <a class="btn btn-default" href="@Url.Action("FormularioCharter", "Charter", new { id = 0,  tipo="02"})"><i><img src='~/Content/imganes/avion3.png' style='width:35px' /></i> Nueva Solicitud</a>
            @*<a class="btn btn-default" href="@Url.Action("Formulario", "Charter", new { id = 0,  tipo="02"})"<i><img src='~/Content/imganes/avion3.png' style='width:35px' /></i> Nueva Solicitud(Tarjeta Crédito)</a>*@
        </div>
        <hr />
        <div class="form-group row">
            <div class="col-lg-12">
                <table id="tbDetalle" class="table table-bordered table-hover table-sm" style="width:100%; font-size:small">
                    <thead class="text-center">
                        <tr>
                            <th class="text-center">No.SOL.</th>
                            <th class="text-center">FECHA SOLICITUD</th>
                            <th class="text-center">FECHA APROBACIÓN</th>
                            <th class="text-center">OPERACIÓN </th>
                            <th class="text-center">ESTADO SOLICITUD</th>
                            <th class="text-center">CIA. OPERADORA</th>
                            <th class="text-center">CIA. FLETADOR</th>
                            <th class="text-center">APROBADO</th>
                            <th class="text-center">No. AUTORIZACIÓN</th>
                            <th class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody style="font-size:11px">

                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    @Html.DisplayFor(modelItem => item.NumeroSolicitud)
                                </td>
                                <td>
                                    <p class="text-justify">@Html.DisplayFor(modelItem => item.FechaEnvioSolicitud)</p>
                                </td>
                                <td>
                                    <p class="text-justify">@Html.DisplayFor(modelItem => item.FechaTransporteAereo)</p>
                                </td>
                                <td>
                                    <p class="text-justify">@Html.DisplayFor(modelItem => item.DescripcionTipoSolictud)</p>
                                </td>
                                <td>
                                    @if (item.EstadoSolicitud.Equals("AP"))
                                    {
                                        <p class="text-green"> @Html.DisplayFor(modelItem => item.DescripcionSolicitud) </p>

                                    }
                                    else if (item.EstadoSolicitud.Equals("RE"))
                                    {
                                        <p> @Html.DisplayFor(modelItem => item.DescripcionSolicitud) </p>

                                    }
                                    else if (item.EstadoSolicitud.Equals("EN"))
                                    {
                                        if (item.EstadoPago.Equals("APP"))
                                        {
                                            <strong class="text-primary"> @Html.DisplayFor(modelItem => item.DescripcionSolicitud) - PAGADA</strong>
                                        }
                                        else
                                        {
                                            <strong class="text-warning"> @Html.DisplayFor(modelItem => item.DescripcionSolicitud) </strong>
                                        }
                                    }
                                    else
                                    {

                                    }
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.NombreCompaniaAviacion)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.NombreFleteador)
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        @if (item.EstadoOperacionesDSOP.Equals("AP"))
                                        {
                                            <strong style="font-size:10px" class="btn btn-primary btn-sm" data-id="@item.NumeroSolicitud" data-toggle="tooltip" data-placement="left" title="@item.DescripcionOperacionesDSOP.Trim() - OPERACIONES">@item.EstadoOperacionesDSOP</strong>
                                        }
                                        @if (item.EstadoFinanciero.Equals("AP"))
                                        {
                                            <strong style="font-size:10px" class="btn btn-secondary btn-sm" data-id="@item.NumeroSolicitud" data-toggle="tooltip" data-placement="left" title="@item.DescripcionEstadoFinanciero.Trim() - FINANCIERO">@item.EstadoFinanciero</strong>
                                        }
                                        @if (item.EstadoTransporteAereo.Equals("AP"))
                                        {
                                            <strong style="font-size:10px" class="btn btn-warning btn-sm" data-id="@item.NumeroSolicitud" data-toggle="tooltip" data-placement="left" title="@item.DescripcionEstadoTransporteAereo.Trim() - TRANSPORTE AÉREO">@item.EstadoTransporteAereo</strong>
                                        }
                                    </div>
                                </td>
                                <td>
                                    @if (item.EstadoResponsableATO != "")
                                    {
                                        @Html.DisplayFor(modelItem => item.AutorizacionSolicitudVuelo)
                                    }

                                </td>
                                <td>
                                    <table style="width:100%">
                                        <tr>
                                            <td>
                                                <a id="consultar" href="#" onclick="consultarC(@item.NumeroSolicitud);">
                                                    <i>
                                                        <img src="~/Content/imganes/icons/search_document.ico" style="width:13px" />
                                                    </i>
                                                    Consular
                                                </a>
                                            </td>
                                            @if (item.EstadoSolicitud.Equals("RE") && item.EstadoPago.Equals(""))
                                            {
                                                <td>
                                                    <a id="anular" href="#" onclick="anular(@item.NumeroSolicitud);">
                                                        <i>
                                                            <img src="~/Content/imganes/icons/deletedocument.ico" style="width:13px" />
                                                        </i>
                                                        Anular
                                                    </a>
                                                </td>

                                            }
                                            @if (item.AutorizacionSolicitudVuelo.Trim().Length > 0)
                                            {
                                                if (item.EstadoTransporteAereo.Equals("AP") && item.EstadoResponsableATO != "")
                                                {
                                                    <td>
                                                        <a id="imprimir" href="#" onclick="imprimirAutorizacion('@item.AutorizacionSolicitudVuelo');">
                                                            <i>
                                                                <img src="~/Content/imganes/icons/print-black-printer.ico" style="width:13px" />
                                                            </i>
                                                            Imprimir
                                                        </a>
                                                    </td>

                                                }

                                            }
                                            else if (item.EstadoSolicitud.Equals("RE") && item.EstadoPago.Equals(""))
                                            {
                                                <td>
                                                    <a id="enviar" class="text-center" href="#" onclick="enviar(@item.NumeroSolicitud);">
                                                        <i>
                                                            <img src="~/Content/imganes/icons/process_accepting.ico" style="width:13px" />
                                                        </i>
                                                        Enviar
                                                    </a>
                                                </td>
                                            }
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        }


                    </tbody>
                </table>
                <br />
                <div class="card card-default">
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="form-group row">
                                <div class="col-sm-12" style="font-size:14px">
                                    <ul>
                                        <li type="circule">
                                            <p style="color:#000000;  text-align:justify">
                                                <strong>
                                                    Al enviar este formulario, DECLARO que conozco y me someto a la legislación ecuatoriana aplicable; que toda la información proporcionada para obtener la autorización solicitada ES CIERTA, COMPLETA Y ACTUALIZADA.
                                                </strong>
                                            </p>
                                        </li>
                                        <li type="circule">
                                            <p style="color:#000000;  text-align:justify">
                                                <strong>
                                                    El operador es responsable que las operaciones se realicen cumpliendo con las leyes y regulaciones del Ecuador; No se transporta sustancias prohibidas o mercancías peligrosas, excepto que exista autorización escrita de las Autoridades competentes y la Dirección General de Aviación Civil del Ecuador. De acuerdo a la Resolución Nro. DGAC-DGAC
                                                </strong>
                                            </p>
                                        </li>
                                    </ul>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
    <!-- /.card-body -->
</div>
<!-- Modal load-->
<div class="modal fade" id="modalload" tabindex="-1" role="dialog" aria-labelledby="loadMeLabel">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <img src="~/Content/imganes/Loading.gif" />
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        $('#tbDetalle').DataTable({
            scrollY: '380px',
            scrollCollapse: true,
            paging: false,
            order: [[0, 'desc']],
            language: {
                "decimal": "",
                "emptyTable": "No hay información",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
                "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
                "infoFiltered": "(Filtrado de _MAX_ total entradas)",
                "infoPostFix": "",
                "thousands": ",",
                "lengthMenu": "Mostrar _MENU_ Entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "Sin resultados encontrados",
                "paginate": {
                    "first": "Primero",
                    "last": "Ultimo",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            }
        });

        function consultar($id) {
            var texto = "";
            if ($id != null) {
                $('#modalload').modal('show');
                if ($id > 0) {
                    texto = $.MisUrls.url._ConsultaSolicitud + "?id=" + $id;
                }
                // Open the page in a new tab or window
                //var w = window.open(texto);
                window.location.href = texto;
            }
        }

        function imprimirAutorizacionRespaldo(id) {

            var texto = $.MisUrls.url._ExportarPdfAutorizacion + "?id=" + id;
            // Open the page in a new tab or window
            var w = window.open(texto);
        }

        function editar($id) {
            var texto = "";
            if ($id != null) {
                $('#modalload').modal('show');
                if ($id > 0) {
                    texto = $.MisUrls.url._SolicitudCharter + "?id=" + $id;
                }
                // Open the page in a new tab or window
                //var w = window.open(texto);
                window.location.href = texto;
            }
        }

        function editarPago($id) {
            var texto = "";
            if ($id != null) {
                $('#modalload').modal('show');
                if ($id > 0) {
                    texto = $.MisUrls.url._SolicitudCharterPago + "?id=" + $id;
                }
                // Open the page in a new tab or window
                //var w = window.open(texto);
                window.location.href = texto;
            }
        }

        function consultarC($id) {
            var texto = "";
            if ($id != null) {
                $('#modalload').modal('show');
                if ($id > 0) {
                    texto = $.MisUrls.url._ConsultaSolicitudC + "?id=" + $id;
                }
                // Open the page in a new tab or window
                //var w = window.open(texto);
                window.location.href = texto;
            }
        }

        function enviar($id) {

            if ($id > 0) {
                var textMensaje = "<p style='color: #000000; font-size:13px; text-align: justify'> <strong class='text-blue'>"
                    + "Al enviar este formulario, DECLARO que conozco y me someto a la legislación ecuatoriana aplicable; que toda la información proporcionada para obtener la autorización solicitada ES CIERTA, COMPLETA Y ACTUALIZADA.</strong ></p>"
                    + "<p style='color: #000000; font-size:13px; text-align: justify'><strong class='text-blue'>El operador es responsable que las operaciones se realicen cumpliendo con las leyes y regulaciones del Ecuador; No se transporta substancias prohibidas o mercancías peligrosas, excepto que exista autorización escrita de las Autoridades competentes y la Dirección General de Aviación Civil del Ecuador.</strong ></p>";
                Swal.fire({
                    title: 'Solicitar aprobación de la solicitud ' + $id,
                    html: textMensaje,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#C5C7CF',
                    cancelButtonText: "Cancelar",
                    confirmButtonText: 'Enviar',

                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#modalload').modal('show');
                        jQuery.ajax({
                            url: $.MisUrls.url._EnviarSolicitudCharterAprobar,
                            type: "GET",
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            data: { id: $id },
                            success: function (data) {
                                if (data.resultado) {
                                    $('#modalload').modal('hide');
                                    window.location.reload();
                                } else {
                                    Swal.fire("Mensaje", "No se pudo envíar la Solitud de Vuelo", "warning");
                                    $('#modalload').modal('hide');
                                }
                            },
                            error: function (error) {
                                console.log(error);
                                $('#modalload').modal('hide');
                            },
                            beforeSend: function () {
                            }
                        });
                    }
                })
            }
            else {
                Swal.fire("Mensaje", "No puede enviar la Solitud de Vuelo", "warning");
            }

        }

        function anular($id) {

            if ($id > 0) {
                Swal.fire({
                    title: 'Confirmar?',
                    text: "¿Desea anular la solicitud " + $id,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#C5C7CF',
                    confirmButtonText: 'Aceptar',
                    cancelButtonText: "Cancelar",
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#modalload').modal('show');
                        jQuery.ajax({
                            url: $.MisUrls.url._FormularioAnularSolicitudVuelor,
                            type: "GET",
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            data: { id: $id },
                            success: function (data) {
                                if (data.resultado) {
                                    $('#modalload').modal('hide');
                                    window.location.reload();
                                } else {
                                    Swal.fire("Mensaje", "No se pudo anular la solitud charter", "warning");
                                    $('#modalload').modal('hide');
                                }
                            },
                            error: function (error) {
                                console.log(error);
                                $('#modalload').modal('hide');
                            },
                            beforeSend: function () {
                                $('#modalload').modal('hide');
                            }
                        });
                    }
                })

            }
            else {
                Swal.fire("Mensaje", "No puede anular la Solitud de Vuelo", "warning");
            }

        }

        function imprimir(id) {
            var texto = $.MisUrls.url._ImprimirAutorizacionCharter + "?id=" + id;
            // Open the page in a new tab or window
            var w = window.open(texto);

        }

        function imprimirAutorizacion(fileName) {
            //var texto = $.MisUrls.url._FormularioImprimir + "?id=" + id;
            // Open the page in a new tab or window
            //var w = window.open(texto);
            var nombreArchivo = fileName + "-signed.pdf";
            $.ajax({
                type: "POST",
                url: $.MisUrls.url._DownloadAutorizacion,
                data: '{fileName: "' + nombreArchivo + '"}',
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                success: function (r) {
                    //Convert Base64 string to Byte Array.
                    var bytes = Base64ToBytes(r);

                    //Convert Byte Array to BLOB.
                    var blob = new Blob([bytes], { type: "application/octetstream" });

                    //Check the Browser type and download the File.
                    var isIE = false || !!document.documentMode;
                    if (isIE) {
                        window.navigator.msSaveBlob(blob, nombreArchivo);
                    } else {
                        var url = window.URL || window.webkitURL;
                        link = url.createObjectURL(blob);
                        var a = $("<a />");
                        a.attr("download", nombreArchivo);
                        a.attr("href", link);
                        $("body").append(a);
                        a[0].click();
                        $("body").remove(a);
                    }
                }
            });
        }

        function Base64ToBytes(base64) {
            var s = window.atob(base64);
            var bytes = new Uint8Array(s.length);
            for (var i = 0; i < s.length; i++) {
                bytes[i] = s.charCodeAt(i);
            }
            return bytes;
        }

    </script>
}

